import scrapy, logging
from cve.items import CveItem


class CveSpider(scrapy.Spider):
    name = 'cve'
    allowed_domains = ['localhost','nvd.nist.gov']
    start_urls = ['http://localhost/today.html']
    #allowed_domains = ['cassandra.cerias.purdue.edu', 'nvd.nist.gov']
    #start_urls = ['https://cassandra.cerias.purdue.edu/CVE_changes/today.html']
    
    
    
    def start_requests(self):
        for url in self.start_urls:
            yield scrapy.Request(url=url, callback=self.cve_parse,)
            
    def cve_parse(self, response):
        res = response.xpath("//a")
        for ids in res:
            id = ids.xpath("./text()").extract_first()
            cveid = "CVE-" + id
            url = "https://nvd.nist.gov/vuln/detail/{}".format(cveid)
            #url = "http://localhost/{}.html".format(cveid)
            #item = CveItem()
            #item["cve_id"] = cveid
            #yield item
            yield scrapy.Request(url=url, callback=self.search, meta={'id':cveid})
              
    def search(self, response):
        sec_cve_id = response.meta['id']
        
        logging.debug("*" * 40)
        logging.debug("response headers: %s" % response.headers)
        logging.debug("request headers: %s" % response.request.headers)
        logging.debug("*" * 40)
        
        description = response.xpath("/html/body/div[2]/div[2]/div[2]/table/tbody/tr/td/div/div[1]/p[1]/text()").extract_first()
        severity = response.xpath("/html/body/div[2]/div[2]/div[2]/table/tbody/tr/td/div/div[1]/div[2]/div[2]/div[1]/div[2]/span/span/a/text()").extract_first()
        publish = response.xpath("/html/body/div[2]/div[2]/div[2]/table/tbody/tr/td/div/div[2]/div/span[1]/text()").extract_first()

        #published = publish.split('/')[2] + "/" + publish.split('/')[0] + "/" + publish.split('/')[1]
        
        item = CveItem()
        item["cve_id"] = sec_cve_id
        item["cve_desc"] = description
        #item["cve_score"] = severity.split(' ')[0]
        #item["cve_severity"] = severity.split(' ')[1]
        #item["cve_published_date"] = publish

        yield item
