import datetime, logging

today = datetime.date.today()
str_today = today.strftime('%Y%m%d')

file_spider = open("spider.csv", "r+", encoding="utf-8")        # 爬出來的結果
file_product = open("product.csv", "r", encoding="utf-8")       # 廠商/產品
file_cve = open("cve.csv", "a", encoding="utf-8")               # 尚未有分數
file_pass = open("pass.csv", "a", encoding="utf-8")             # 不受影響
file_notified = open("notified.csv", "a", encoding="utf-8")     # 受影響
file_sent = open("sent/" + str_today, "w", encoding="utf-8")    # 通知信附件

str_today = today.strftime('%Y/%m/%d')

# 將檔案內容逐行存入 array
spiders = file_spider.read().splitlines()
products = file_product.read().splitlines()

# 刪除標題
del spiders[0]
del products[0]

# 信件 cvs 標題
file_sent.write("notified_date,cve_published_date,cve_id,cve_desc,cve_score,cve_severity,product\n")

# 將爬蟲結果分類
#  - 尚未有 CVSS score 的寫入 cve.csv
#  - 有 CVSS score 但 severity low 的寫入 pass.csv
#  - 有 CVSS score 且 severity medium 以上，但未在 product 清單的寫入 pass.csv
#  - 有 CVSS score 且 severity medium 以上，且在 product 清單的寫入 notified.csv、sent
for i in spiders: 
    # [0]description, [1]id, [2]is_new, [3]published date, [4]cvss score, [5]severity
    content = i.split(',CVE')
    tmp = content[1]
    tmp = tmp.split(',')
    content[1] = "CVE" + tmp[0]
    for j in [2,3,4,5]:
        content.append(tmp[j-1])
        
    # 舊條目不處理
    if content[2] == "F":
        continue
    # pass.csv
    #   checked date, cve published date, cve id, description, cvss score, severity
    elif content[5] == "LOW": 
        file_pass.write(str_today + "," + content[3] + "," + content[1] + "," + content[0] + "," + content[4] + "," + content[5] + "\n")
    # notified.csv: 
    #   notified date, cve published date, cve id, description, cvss score, severity, product
    elif content[5] == "MEDIUM" or content[5] == "HIGH" or content[5] == "CRITICAL": 
        tmp = 0
        for j in products: 
            if j.lower() in content[0].lower():
                tmp = 1
                file_notified.write(str_today + "," + content[3] + "," + content[1] + "," + content[0] + "," + content[4] + "," + content[5] + "\n")
                file_sent.write(str_today + "," + content[3] + "," + content[1] + "," + content[0] + "," + content[4] + "," + content[5] + "\n")
                break
        if tmp == 0:
            file_pass.write(str_today + "," + content[3] + "," + content[1] + "," + content[0] + "," + content[4] + "," + content[5] + "\n")
    # cve.csv
    #   entry data, published date, id, description, cvss score, severity
    else: 
        file_cve.write(str_today + "," + content[3] + "," + content[1] + "," + content[0] + "," + content[4] + "," + content[5] + "\n")

file_spider.seek(0)
file_spider.truncate()

file_spider.close()
file_product.close()
file_cve.close()
file_pass.close()
file_notified.close()
file_sent.close()


