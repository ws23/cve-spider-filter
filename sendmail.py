import smtplib
from email.mime.multipart import MIMEMultipart #email內容載體
from email.mime.text import MIMEText #用於製作文字內文
from email.mime.base import MIMEBase #用於承載附檔
from email import encoders #用於附檔編碼
import datetime
import ssl
import conf

today = datetime.date.today()
str_today = today.strftime('%Y%m%d')
file_sent = conf.path + "sent\\" + str_today + ".csv"

#寄件者使用的Gmail帳戶資訊
gmail_user = 'xxx@gmail.com'
gmail_password = '*****'
from_address = gmail_user
  
#設定信件內容與收件人資訊
to_address = ['somebody@domain.com']  
Subject = "CVE daily report - {}".format(str_today)
contents = """
This is the CVE crawler report at {}. 

Regards,
Eunice Lin
""".format(str_today)

# 設定附件（可設多個）
attachments = [file_sent]
 
#開始組合信件內容
mail = MIMEMultipart()
mail['From'] = from_address
mail['To'] = ', '.join(to_address)
mail['Subject'] = Subject
#將信件內文加到email中
mail.attach(MIMEText(contents))     
#將附加檔案們加到email中   
for file in attachments:
    with open(file, 'rb') as fp:
        add_file = MIMEBase('application', "octet-stream")
        add_file.set_payload(fp.read())
    encoders.encode_base64(add_file)
    add_file.add_header('Content-Disposition', 'attachment', filename='cve_scannig_{}.csv'.format(str_today))
    mail.attach(add_file)
 

# 設定smtp伺服器並寄發信件    
smtpserver = smtplib.SMTP_SSL("smtp.gmail.com", 465)
smtpserver.ehlo()
smtpserver.login(gmail_user, gmail_password)
smtpserver.sendmail(from_address, to_address, mail.as_string())
smtpserver.quit()

# reference: 
#   https://medium.com/views-from-bi-pm/%E5%88%86%E4%BA%AB-%E5%A6%82%E4%BD%95%E7%94%A8-python-%E5%AF%84%E4%BF%A1-python-x-email-%E5%B7%A5%E5%85%B7-smtplib-email-6ff4936ce55e